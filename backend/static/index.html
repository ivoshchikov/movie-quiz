<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Movie Quiz</title>
<style>
  body   { font-family:sans-serif;text-align:center;padding:30px }
  h1,h2  { margin:20px 0 }
  #topbar{ margin-bottom:10px;font-size:18px }
  .frame { width:1080px;height:720px;margin:0 auto 20px;background:#eee;
           display:flex;align-items:center;justify-content:center;
           box-shadow:0 2px 6px rgba(0,0,0,.2) }
  .frame img { max-width:100%;max-height:100%;object-fit:contain }
  button { display:block;width:260px;margin:8px auto;padding:10px;font-size:16px;cursor:pointer }
  #result{ margin-top:15px;font-size:20px }
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="start">
  <h1>Movie Quiz</h1>
  <button id="btnStart">–ò–≥—Ä–∞—Ç—å</button>
</div>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –≠–∫—Ä–∞–Ω –∏–≥—Ä—ã ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="game" style="display:none">
  <div id="topbar">‚è± <span id="timer">20</span> —Å ¬∑ üéØ <span id="score">0</span></div>
  <div class="frame"><img id="poster" alt="–ö–∞–¥—Ä"></div>
  <div id="options"></div>
  <div id="result"></div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –≠–∫—Ä–∞–Ω Game Over ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="gameover" style="display:none">
  <h2>–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞</h2>
  <p>–í–∞—à —Å—á—ë—Ç: <span id="finalScore"></span></p>
  <button id="btnRestart">–°—ã–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
</div>

<script>
/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
let score   = 0;
let shown   = [];         // id —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
let timerId = null;
let timeLeft= 20;
let currentQuestion = null;

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ DOM —ç–ª–µ–º–µ–Ω—Ç—ã ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const el = id => document.getElementById(id);
el('btnStart'  ).onclick = startGame;
el('btnRestart').onclick = startGame;

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –°–º–µ–Ω–∞ —ç–∫—Ä–∞–Ω–æ–≤ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function screen(name){
  start.style.display    = name==='start'    ? 'block':'none';
  game.style.display     = name==='game'     ? 'block':'none';
  gameover.style.display = name==='gameover' ? 'block':'none';
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–π –∏–≥—Ä—ã ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function startGame(){
  score = 0; shown = [];
  el('score').textContent = 0;
  screen('game');
  loadQuestion();
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –¢–∞–π–º–µ—Ä 20 —Å–µ–∫—É–Ω–¥ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function startTimer(){
  timeLeft = 20;
  el('timer').textContent = timeLeft;
  clearInterval(timerId);
  timerId = setInterval(() => {
    timeLeft--;
    el('timer').textContent = timeLeft;
    if (timeLeft === 0){ clearInterval(timerId); endRound(false); }
  }, 1000);
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ü–æ–¥–≥—Ä—É–∑–∫–∞ –≤–æ–ø—Ä–æ—Å–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function loadQuestion(){
  const res = await fetch(`/question?exclude=${shown.join(',')}`);
  if(res.status === 404){ endRound(false); return; } // –≤–æ–ø—Ä–æ—Å—ã –∫–æ–Ω—á–∏–ª–∏—Å—å
  const data = await res.json();

  currentQuestion = data;
  shown.push(data.id);

  /* –∫–∞—Ä—Ç–∏–Ω–∫–∞ */
  el('poster').src = data.image_url + '?t=' + Date.now();

  /* –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã */
  data.options.sort(()=>Math.random()-0.5);

  /* –∫–Ω–æ–ø–∫–∏ */
  const box = el('options'); box.innerHTML = '';
  data.options.forEach(option=>{
    const btn = document.createElement('button');
    btn.textContent = option;
    btn.onclick = ()=>checkAnswer(option);
    box.appendChild(btn);
  });

  el('result').textContent = '';
  startTimer();
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function checkAnswer(choice){
  clearInterval(timerId);
  const res = await fetch('/answer', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({question_id:currentQuestion.id, answer:choice})
  });
  const data = await res.json();
  endRound(data.correct, data.correct_answer);
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ö–æ–Ω–µ—Ü —Ä–∞—É–Ω–¥–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function endRound(correct, right=''){
  if(correct){
    score++; el('score').textContent = score;
    el('result').textContent = '‚úÖ –í–µ—Ä–Ω–æ!';
    el('result').style.color = 'green';
    setTimeout(loadQuestion, 800);
  } else {
    if(right) el('result').textContent = '‚ùå –ù–µ–≤–µ—Ä–Ω–æ. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π: '+right;
    el('finalScore').textContent = score;
    screen('gameover');
  }
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ü–æ–∫–∞–∑ —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ —ç–∫—Ä–∞–Ω–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
screen('start');
</script>
</body>
</html>
